#!/bin/bash 
SCREEN_FILENAME="/tmp/fosbox/lcd.jpg"

MAX_R=`cat /tmp/fosbox/audio | grep "Max level" | tr -s ' ' | cut -f 5 -d ' '`
MAX_L=`cat /tmp/fosbox/audio | grep "Max level" | tr -s ' ' | cut -f 4 -d ' '`

echo "# HELP fosbox_maxvol Maximum volume of stream
# TYPE fosbox_maxvol gauge
fosbox_maxvol{chan=\"left\"} $MAX_L
fosbox_maxvol{chan=\"right\"} $MAX_R
" > /tmp/fosbox/data

BLACK_PERCENT=`convert ${SCREEN_FILENAME} -threshold 5% -format "%[fx:100*image.mean]" -negate info:`
echo "# HELP fosbox_blackness The percentage of black on the stream
# TYPE fosbox_blackness gauge
fosbox_blackness ${BLACK_PERCENT}
" >> /tmp/fosbox/data

